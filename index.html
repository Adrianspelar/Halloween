<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Galleria – Rutnät & Namngivna Butiker + Rapporter</title>
  <style>
    body {
      margin: 0;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      overflow-y: auto; /* Scrollbart! */
    }
    #top-section {
      position: relative;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 3px solid #333;
      cursor: default;
    }
    .info {
      text-align: center;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .legend {
      text-align: center;
      margin-top: 10px;
    }
    .worker {
      display: inline-block;
      margin: 0 10px;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .ledig { background: #90ee90; color: #000; }
    .upptagen { background: #ff6b6b; color: #fff; }
    .selected { box-shadow: 0 0 10px #0066ff; }

    /* Rapportformulär – NEDANFÖR kartan */
    #report-section {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
    }
    #report-section h2 {
      text-align: center;
    }
    #report-form label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    #report-form input, #report-form select, #report-form textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #report-form button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #report-form button:hover {
      background: #45a049;
    }

    /* Notifikationer – ÖVERST på skärmen, fixed */
    #notifications {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      pointer-events: none;
    }
    .notif {
      max-width: 900px;
      margin: 10px auto;
      padding: 15px;
      background: #ffff99;
      border: 2px solid #cccc00;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      pointer-events: auto;
      opacity: 0;
      transition: opacity 0.5s;
    }
    .notif.show {
      opacity: 1;
    }
    .notif .timer {
      margin-top: 10px;
      height: 5px;
      background: #ccc;
      position: relative;
    }
    .notif .timer-bar {
      height: 100%;
      background: #4CAF50;
      width: 100%;
      transition: width 0.1s linear;
    }

    /* Flash på kartan */
    .flash {
      position: absolute;
      background: rgba(255, 255, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      animation: flashAnim 0.5s ease-out forwards;
    }
    @keyframes flashAnim {
      0% { transform: scale(0.5); opacity: 0.8; }
      100% { transform: scale(3); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="notifications"></div>

  <div id="top-section">
    <div class="info">
      <strong>Klicka på en arbetare → Klicka på mål → Går och kan STANNA mitt på vägen!</strong><br>
      Tangent 1–5: Växla Ledig/Upptaget
    </div>
    <canvas id="map" width="900" height="600"></canvas>
    <div class="legend" id="legend"></div>
  </div>

  <!-- RAPPORTFORMULÄR – Scrolla ner för att se! -->
  <div id="report-section">
    <h2>Skapa Rapport</h2>
    <form id="report-form">
      <label for="title">Titel:</label>
      <input type="text" id="title" required />

      <label for="problem">Problem:</label>
      <textarea id="problem" rows="4" required></textarea>

      <label for="priority">Prioritet:</label>
      <select id="priority" required>
        <option value="">Välj...</option>
        <option value="Låg">Låg</option>
        <option value="Medel">Medel</option>
        <option value="Hög">Hög</option>
      </select>

      <button type="submit">Skicka Rapport</button>
    </form>
  </div>

  <script>
    const canvas = document.getElementById('map');
    const ctx = canvas.getContext('2d');
    const legend = document.getElementById('legend');
    const topSection = document.getElementById('top-section');
    const notifications = document.getElementById('notifications');
    const reportForm = document.getElementById('report-form');

    // Arbetare – LÅNGSAM
    const workers = [
      { id: 1, x: 150, y: 150, status: 'Ledig', selected: false, path: [], target: null, speed: 0.3 },
      { id: 2, x: 400, y: 100, status: 'Ledig', selected: false, path: [], target: null, speed: 0.3 },
      { id: 3, x: 700, y: 200, status: 'Ledig', selected: false, path: [], target: null, speed: 0.3 },
      { id: 4, x: 300, y: 400, status: 'Ledig', selected: false, path: [], target: null, speed: 0.3 },
      { id: 5, x: 600, y: 450, status: 'Ledig', selected: false, path: [], target: null, speed: 0.3 }
    ];

    // NAMNGIVNA BUTIKER
    const shops = [
      {x: 50,  y: 50,  w: 150, h: 120, name: "H&M"},
      {x: 250, y: 50,  w: 120, h: 100, name: "Zara"},
      {x: 400, y: 50,  w: 180, h: 80,  name: "Elgiganten"},
      {x: 620, y: 50,  w: 140, h: 100, name: "Åhléns"},
      {x: 50,  y: 200, w: 100, h: 150, name: "Espresso House"},
      {x: 180, y: 200, w: 160, h: 130, name: "Guldfynd"},
      {x: 380, y: 180, w: 200, h: 120, name: "McDonald's"},
      {x: 620, y: 180, w: 180, h: 140, name: "BR Leksaker"},
      {x: 50,  y: 380, w: 180, h: 140, name: "Apoteket Hjärtat"},
      {x: 260, y: 350, w: 140, h: 160, name: "Intersport"},
      {x: 450, y: 350, w: 160, h: 140, name: "Clas Ohlson"},
      {x: 650, y: 380, w: 150, h: 140, name: "Jysk"}
    ];

    // KORSNINGAR (samma rutnät)
    const intersections = [
      {x: 200, y: 170}, {x: 380, y: 170}, {x: 590, y: 170}, {x: 770, y: 170},
      {x: 200, y: 330}, {x: 380, y: 330}, {x: 590, y: 330}, {x: 770, y: 330},
      {x: 200, y: 520}, {x: 380, y: 520}, {x: 590, y: 520}, {x: 770, y: 520},
      {x: 450, y: 30}, {x: 450, y: 570}
    ];

    // Hitta närmaste korsning
    function nearestIntersection(x, y) {
      let minDist = Infinity;
      let best = null;
      intersections.forEach(p => {
        const dist = Math.hypot(p.x - x, p.y - y);
        if (dist < minDist) {
          minDist = dist;
          best = p;
        }
      });
      return { point: best, dist: minDist };
    }

    // A* – ger korsningar
    function findPath(start, goal) {
      const openSet = [];
      const cameFrom = {};
      const gScore = {};
      const fScore = {};

      const key = p => `${p.x},${p.y}`;
      const startKey = key(start);
      const goalKey = key(goal);

      gScore[startKey] = 0;
      fScore[startKey] = Math.hypot(goal.x - start.x, goal.y - start.y);
      openSet.push({ point: start, f: fScore[startKey] });

      const neighbors = (p) => {
        const dirs = [];
        intersections.forEach(ip => {
          if (ip.y === p.y && Math.abs(ip.x - p.x) > 0) dirs.push(ip);
          if (ip.x === p.x && Math.abs(ip.y - p.y) > 0) dirs.push(ip);
        });
        return dirs.filter(n => {
          const mx = (p.x + n.x) / 2, my = (p.y + n.y) / 2;
          return !shops.some(s => mx >= s.x && mx <= s.x + s.w && my >= s.y && my <= s.y + s.h);
        });
      };

      while (openSet.length > 0) {
        openSet.sort((a, b) => a.f - b.f);
        const current = openSet.shift().point;
        const currentKey = key(current);

        if (currentKey === goalKey) {
          const path = [];
          let step = current;
          while (step) {
            path.unshift(step);
            step = cameFrom[key(step)];
          }
          return path;
        }

        neighbors(current).forEach(neighbor => {
          const nKey = key(neighbor);
          const tentativeG = gScore[currentKey] + Math.hypot(neighbor.x - current.x, neighbor.y - current.y);

          if (!(nKey in gScore) || tentativeG < gScore[nKey]) {
            cameFrom[nKey] = current;
            gScore[nKey] = tentativeG;
            fScore[nKey] = tentativeG + Math.hypot(goal.x - neighbor.x, goal.y - neighbor.y);
            if (!openSet.some(o => key(o.point) === nKey)) {
              openSet.push({ point: neighbor, f: fScore[nKey] });
            }
          }
        });
      }
      return [start, goal];
    }

    // Dela upp varje sträcka i små steg (var 30 pixlar)
    function subdividePath(path) {
      const finePath = [];
      for (let i = 0; i < path.length - 1; i++) {
        const a = path[i];
        const b = path[i + 1];
        const dx = b.x - a.x;
        const dy = b.y - a.y;
        const dist = Math.hypot(dx, dy);
        const steps = Math.ceil(dist / 30);
        for (let j = 0; j <= steps; j++) {
          const t = j / steps;
          finePath.push({
            x: a.x + dx * t,
            y: a.y + dy * t
          });
        }
      }
      if (path.length > 0) finePath.push(path[path.length - 1]);
      return finePath;
    }

    // Rita allt
    function drawMap() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#e8e8e8';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#d4a5a5';
      ctx.strokeStyle = '#8b5a5a';
      ctx.lineWidth = 3;
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      shops.forEach(shop => {
        ctx.fillRect(shop.x, shop.y, shop.w, shop.h);
        ctx.strokeRect(shop.x, shop.y, shop.w, shop.h);
        ctx.fillStyle = '#000';
        ctx.fillText(shop.name, shop.x + shop.w/2, shop.y + shop.h/2 + 5);
        ctx.fillStyle = '#d4a5a5';
      });

      ctx.strokeStyle = '#555';
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(0, 170); ctx.lineTo(900, 170);
      ctx.moveTo(0, 330); ctx.lineTo(900, 330);
      ctx.moveTo(0, 520); ctx.lineTo(900, 520);
      ctx.moveTo(200, 0); ctx.lineTo(200, 600);
      ctx.moveTo(380, 0); ctx.lineTo(380, 600);
      ctx.moveTo(590, 0); ctx.lineTo(590, 600);
      ctx.moveTo(770, 0); ctx.lineTo(770, 600);
      ctx.stroke();

      ctx.fillStyle = '#4CAF50';
      ctx.fillRect(420, 0, 60, 30);
      ctx.fillRect(420, 570, 60, 30);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 14px Arial';
      ctx.fillText("ENTRÉ", 450, 20);
      ctx.fillText("UTRÉ", 450, 595);

      workers.forEach(w => {
        if (w.path.length > 1) {
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(w.x, w.y);
          w.path.forEach(p => ctx.lineTo(p.x, p.y));
          ctx.stroke();
          ctx.setLineDash([]);
        }
      });

      workers.forEach(w => {
        ctx.beginPath();
        ctx.arc(w.x, w.y, 18, 0, Math.PI * 2);
        ctx.fillStyle = w.status === 'Ledig' ? '#90ee90' : '#ff6b6b';
        ctx.fill();
        ctx.strokeStyle = w.selected ? '#0066ff' : '#000';
        ctx.lineWidth = w.selected ? 4 : 2;
        ctx.stroke();

        ctx.fillStyle = '#000';
        ctx.font = 'bold 20px Arial';
        ctx.textBaseline = 'middle';
        ctx.fillText(w.id, w.x, w.y);

        ctx.font = '12px Arial';
        ctx.fillText(w.status, w.x, w.y + 30);
      });

      updateLegend();
    }

    function updateLegend() {
      legend.innerHTML = '';
      workers.forEach(w => {
        const span = document.createElement('span');
        span.className = `worker ${w.status === 'Ledig' ? 'ledig' : 'upptagen'}${w.selected ? ' selected' : ''}`;
        span.textContent = `${w.id}: ${w.status}${w.selected ? ' (vald)' : ''}`;
        legend.appendChild(span);
      });
    }

    // Klick på karta
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      let clickedWorker = null;
      workers.forEach(w => {
        if (Math.hypot(w.x - x, w.y - y) < 25) {
          clickedWorker = w;
        }
      });

      if (clickedWorker) {
        workers.forEach(w => w.selected = false);
        clickedWorker.selected = true;
        drawMap();
      } else if (workers.some(w => w.selected)) {
        const selected = workers.find(w => w.selected);
        const nearest = nearestIntersection(x, y);
        if (nearest.dist < 100) {
          const start = nearestIntersection(selected.x, selected.y).point;
          const coarsePath = findPath(start, nearest.point);
          const finePath = subdividePath(coarsePath);
          selected.path = finePath;
          selected.target = nearest.point;
          selected.selected = false;
          selected.status = 'Upptaget';
          drawMap();
        }
      }
    });

    // Tangentbord
    document.addEventListener('keydown', e => {
      const key = parseInt(e.key);
      if (key >= 1 && key <= 5) {
        const w = workers.find(w => w.id === key);
        if (w && w.path.length === 0) {
          w.status = w.status === 'Ledig' ? 'Upptaget' : 'Ledig';
          drawMap();
        }
      }
    });

    // Animation
    function animate() {
      let moved = false;
      workers.forEach(w => {
        if (w.path.length > 0) {
          const target = w.path[0];
          const dx = target.x - w.x;
          const dy = target.y - w.y;
          const dist = Math.hypot(dx, dy);

          if (dist < w.speed) {
            w.x = target.x;
            w.y = target.y;
            w.path.shift();
            if (w.path.length === 0) w.status = 'Ledig';
            moved = true;
          } else {
            w.x += (dx / dist) * w.speed;
            w.y += (dy / dist) * w.speed;
            moved = true;
          }
        }
      });
      if (moved) drawMap();
      requestAnimationFrame(animate);
    }

    // *** NYTT: RAPPORTSYSTEM ***
    let reportCounter = 0;

    reportForm.addEventListener('submit', e => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const problem = document.getElementById('problem').value.trim();
      const priority = document.getElementById('priority').value;

      if (!title || !problem || !priority) return;

      reportCounter++;
      const reportId = `report-${reportCounter}`;
      const clickX = Math.random() * canvas.width;
      const clickY = Math.random() * canvas.height;

      // 1. Flash på kartan i 5 sek
      const flash = document.createElement('div');
      flash.className = 'flash';
      flash.style.left = `${clickX - 50}px`;
      flash.style.top = `${clickY - 50}px`;
      flash.style.width = '100px';
      flash.style.height = '100px';
      topSection.appendChild(flash);
      setTimeout(() => flash.remove(), 5000); // Synlig i 5 sek (anim 0.5s + rest)

      // 2. Notifikation överst – visas EFTER 5 sek, timer 3 min
      setTimeout(() => {
        const notif = document.createElement('div');
        notif.className = 'notif';
        notif.innerHTML = `
          <strong>${title}</strong> (Prioritet: ${priority})<br>
          ${problem}
          <div class="timer"><div class="timer-bar"></div></div>
        `;
        notifications.appendChild(notif);

        setTimeout(() => notif.classList.add('show'), 100);

        const timerBar = notif.querySelector('.timer-bar');
        const startTime = Date.now();
        const duration = 3 * 60 * 1000; // 3 min

        const updateTimer = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.max(0, (duration - elapsed) / duration);
          timerBar.style.width = `${progress * 100}%`;
          if (progress > 0) {
            requestAnimationFrame(updateTimer);
          } else {
            notif.classList.remove('show');
            setTimeout(() => notif.remove(), 500);
          }
        };
        updateTimer();
      }, 5000);

      // Reset form
      reportForm.reset();
    });

    drawMap();
    animate();
  </script>
</body>
</html>
